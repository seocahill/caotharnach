<!-- index.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title>Speech Recognition and Text-to-Speech App</title>
  </head>
  <body>
    <input type="button" id="startBtn" value="Start Recording">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function() {
          const startBtn = document.getElementById('startBtn');
          let mediaRecorder;
          let isRecording = false;

          startBtn.addEventListener('click', toggleRecording);

          async function toggleRecording(e) {
              if (!isRecording) {
                  try {
                      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                      mediaRecorder = new MediaRecorder(stream);
                      let audioChunks = [];

                      mediaRecorder.ondataavailable = event => {
                          if (event.data.size > 0) {
                              audioChunks.push(event.data);
                          }
                      };

                      mediaRecorder.onstop = async () => {
                          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                          await processAudio(audioBlob);
                      };

                      startBtn.value = 'Stop Recording';
                      isRecording = true;
                      mediaRecorder.start();

                      setTimeout(() => {
                          mediaRecorder.stop();
                          startBtn.value = 'Start Recording';
                          isRecording = false;
                      }, 10000); // Stop recording after 10 seconds
                  } catch (error) {
                      alert('Error recording audio');
                  }
              } else {
                  mediaRecorder.stop();
                  startBtn.value = 'Start Recording';
                  isRecording = false;
              }
          }

          async function processAudio(audioBlob) {
            try {
                const audioString = await blobToBase64(audioBlob);
                const response = await fetch('/forward_audio', {
                  method: 'POST',
                  body: JSON.stringify({ audio_blob: audioString }),
                  headers: {
                  'Content-Type': 'application/json'
                  }
                });

                const data = await response.json();
                // Assuming gaelicResponse is the object you received with audioContent
                const audioContent = data.audioContent;

                // Convert Base64 audio content to Blob
                const decodedAudioBlob = base64ToBlob(audioContent);

                // Create an audio element
                const audio = new Audio();

                // Create a Blob URL from the audio Blob
                const blobUrl = URL.createObjectURL(decodedAudioBlob);

                // Set the audio source to the Blob URL
                audio.src = blobUrl;

                // Play the audio
                audio.play();
            } catch (error) {
                console.error('Error processing audio:', error);
            }
        }

        function base64ToBlob(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type: 'audio/wav' });
        }

        async function blobToBase64(blob) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = error => reject(error);
              reader.readAsDataURL(blob);
          });
        }


        async function chatWithGpt(userInput) {
            const response = await fetch('/chat_with_gpt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_input: userInput })
            });

            return await response.json();
        }
    });
    </script>
  </body>
</html>
